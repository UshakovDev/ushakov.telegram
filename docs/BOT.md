# Как создать Telegram‑бота для модуля (5 минут)

Эта инструкция объясняет, как быстро создать бота у @BotFather и подключить его к модулю.

## 1. Создайте бота в BotFather
1. Откройте в Telegram официальный бот: `@BotFather`.
2. Нажмите Start и отправьте команду:
   ```
   /newbot
   ```
3. Введите **имя** бота (то, что видят пользователи), например: `Магазин уведомления`.
4. Введите **логин** бота - уникальный, должен оканчиваться на `_bot`, например: `myshop_notify_bot`.
5. BotFather пришлёт **токен** вида `123456789:AA...` и подтвердит логин. Сохраните токен - он нужен модулю.

> Советы:
> - Имя можно менять; логин (username) меняется через `/setusername` в BotFather.
> - Токен можно в любой момент регенерировать: `/revoke` → `/token` → выбрать бота.

## 2. (Опционально) Настройте описание и аватар
- Команды BotFather:
  - `/setdescription` - краткое описание бота
  - `/setabouttext` - «о боте»
  - `/setuserpic` - аватар

Это не обязательно, но повышает доверие пользователей.

## 3. Вставьте токен и логин в модуль
1. Откройте админку Bitrix → Настройки → Настройки модулей → **ushakov.telegram** → Настройки.
2. Заполните поля:
   - `BOT_TOKEN` - токен из BotFather (формат `123456:AA...`).
   - `BOT_USERNAME` - логин бота без `@` (например `myshop_notify_bot`).
3. Нажмите **Сохранить/Применить**.

## 4. Установите вебхук
1. На той же странице нажмите **Установить вебхук**.
2. Убедитесь в блоке «Статус вебхука», что:
   - `URL` заполнен ссылкой на `/bitrix/tools/ushakov.telegram/webhook.php?...`;
   - `Pending = 0` (нет необработанных событий);
   - нет ошибок.

> Требования к домену: публичный HTTPS‑домен (можно временно туннель - ngrok/Cloudflare). Сертификат Let’s Encrypt подходит.

## 5. Протестируйте привязку
1. Включите показ кнопки «Привязать Telegram» для покупателей.
2. В ЛК откройте «Мои заказы» и нажмите кнопку «Привязать Telegram» - внизу подсказка.
3. Откройте вашего бота в Telegram, вставьте код (или отправьте `/start <код>`). Бот ответит «✅ Привязка выполнена».

![Bind Telegram](./images/bind-telegram2.jpg)

## 6. Готово - включите нужные уведомления
- В настройках модуля включите чекбоксы событий (для сотрудников и/или покупателей), при необходимости отредактируйте текстовые шаблоны.

---

## Частые вопросы
**Сообщения не приходят, вебхук установлен**  
Проверьте, что сервер может делать исходящие HTTPS‑запросы к `https://api.telegram.org`. На некоторых хостингах требуется включить cURL/установить CA‑сертификаты.

**Часть шаблонов «пропадает» после сохранения**  
Если база в `utf8mb3`, избегайте 4‑байтных эмодзи. Рекомендуется `utf8mb4`.

**Можно ли использовать одного бота для нескольких сайтов?**  
Коротко: зависит от сценария.  
- Разные установки (отдельные проекты/серверы, разные кодовые базы): нет. У Telegram‑бота может быть только один webhook‑URL, он укажет лишь на один сайт. Для каждой установки нужен свой бот (либо внешний прокси, который сам распределяет апдейты).  
- Многосайтовость в рамках одной установки Bitrix (несколько `SITE_ID`): да. Используется один webhook, модуль различает сайт по подписанному HMAC‑payload (`SITE_ID` и `USER_ID`) и хранит привязки с `SITE_ID`.

**Как отключить уведомления пользователю?**  
Пользователь отправляет боту `/stop` (или `/unlink`) - модуль удаляет привязку.

**Безопасно ли?**  
Вебхук защищён секретом; дип‑ссылки `/start` подписаны HMAC‑подписью; переменные в сообщениях экранируются для HTML‑режима - это снижает риск инъекций.

## Поддержка
Если что‑то не работает - проверьте «Статус вебхука» и логи сервера. При необходимости свяжитесь https://t.me/user_four
